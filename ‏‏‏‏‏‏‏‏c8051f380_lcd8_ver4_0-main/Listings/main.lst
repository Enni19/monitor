C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(7,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "compiler_defs.h"
   2          #include "C8051F380_defs.h"
   3          #include "initsys.h"
   4          #include "argb2.h"
   5          #include <math.h> 
   6          #define READ_FROM_TEMP 19 
   7          #define READ_FROM_AMPLIFIER  20 
   8          
   9          float goertzel_mag(int numSamples,int TARGET_FREQUENCY,int SAMPLING_RATE);
  10          int ADC_IN(int num);
  11          int IsAlarmDetected(int numofinstans,int mag);
  12          int IsAlarmDetected2();
  13          int IsAlarmDetected_trial();
  14          
  15          void Init_Device(void);
  16          void mp3();
  17          void Start_Working(void);
  18          void MenuScreen();
  19          void Font_test(void);
  20          void Move(void);
  21          void temperature(void);
  22          void Crying(void);
  23          
  24          #define NUM_OF_FREQ_TO_CHECK 4 
  25          xdata int  NumInstans[NUM_OF_FREQ_TO_CHECK]; 
  26          struct WaveProperty  
  27          {
  28             int freq; 
  29             int Th_mag;
  30             int Th_NumInstans;
  31          };
  32          
  33          //xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{700,100,20},{900,100,20}};
  34          //xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{700,70,8},{800,100,15},{900,60,9}};
  35          xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{700,70,8},{800,100,15},{1000,60,9},{90
             -0,60,9}};// frequencies
  36          //xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{353,20,30},{905,20,20}};            
             -     
  37          //xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{800,100,20}};
  38          //xdata struct WaveProperty wave_property_arr[NUM_OF_FREQ_TO_CHECK]={{800,150,20}};
  39          xdata char my_string[20];          
  40          xdata U16 data_in[210];
  41          xdata num=0;
  42          
  43          
  44          
  45          void PUTCHAR1(char tav)
  46          {
  47   1        SBUF1=tav;
  48   1        while((SCON1&2)==0); //(TI1==0)
  49   1        SCON1=SCON1&(~2);    //TI1 = 0;  
  50   1      }
  51          
  52          void PUTCHAR0(char tav)
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 2   

  53          {
  54   1        SBUF0=tav;
  55   1        while(TI0==0);
  56   1        TI0=0;
  57   1      }
  58          
  59          
  60          extern void Init_Device(void);
  61          
  62          int i;
  63          code char playtrack1[8]={0x7E,0xFF,0x06,0x0F,0x00,0x01,0x02,0xEF}; 
  64          
  65          char playtrack[8];
  66          void play_song(char dir,char song_num)
  67          {
  68   1        playtrack[5]=dir;
  69   1        playtrack[6]=song_num;
  70   1        for (i=0;i<8;i++)
  71   1        PUTCHAR1 (playtrack[i]);
  72   1      }
  73          
  74          void main(void)
  75          {
  76   1        S16 x=0, y=0,  ButtonNum;
  77   1        Init_Device();
  78   1        initSYS();
  79   1      
  80   1        for (i=0;i<8;i++)
  81   1        playtrack[i]=playtrack1[i]; 
  82   1        
  83   1        
  84   1        
  85   1        
  86   1        
  87   1        MenuScreen();
  88   1        
  89   1      
  90   1        while(1) {
  91   2          if(!T_IRQ) {
  92   3            delay_ms(10);
  93   3            x = ReadTouchX();
  94   3            y = ReadTouchY();
  95   3            LCD_setCursor (25, 100);
  96   3            ButtonNum= ButtonTouch(x, y);
  97   3            printf("x=%d y=%d  b=%d   ", x, y,ButtonNum);
  98   3      
  99   3            if(ButtonNum==0){  
 100   4              Start_Working();
 101   4              MenuScreen();
 102   4            }
 103   3            else if(ButtonNum==1){ 
 104   4              mp3();
 105   4              MenuScreen();
 106   4            }
 107   3            else if(ButtonNum==2){
 108   4              Move();
 109   4              MenuScreen();       
 110   4            }
 111   3            else if(ButtonNum==3) {
 112   4              temperature();
 113   4              MenuScreen();
 114   4            }
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 3   

 115   3            else if(ButtonNum==4) {
 116   4              Crying();
 117   4              MenuScreen();
 118   4            }
 119   3          } 
 120   2        }
 121   1      }
 122          
 123          void MenuScreen() {
 124   1        LCD_fillScreen(BLACK);
 125   1        LCD_print2C(0, 10,"BABY MONITOR" , 4,RED, BLACK);   //hebrew    
 126   1        LCD_print2C (0 ,50 ,"YUVAL & ENNI",3, WHITE, BLACK);
 127   1        LCD_clearButton();  
 128   1        LCD_drawButton(0,10,  150,60,60, 10, CYAN,BLACK,"RUN!",2);  
 129   1        LCD_drawButton(1,80, 150,60,60, 10, BLUE,YELLOW,"MP3",2);
 130   1        LCD_drawButton(2,150, 150,60,60, 10, GREEN,BLACK,"Move",2);
 131   1        LCD_drawButton(3,217, 150,66,60, 10, YELLOW,BLACK,"Temperature",1);
 132   1        LCD_drawButton(4,290, 150,60,60, 10, PINK,BLACK,"Crying",2);
 133   1        LCD_setText2Color(WHITE,BLACK);
 134   1      }
 135          
 136          
 137          
 138          
 139          void Start_Working(void) {                      //  Start Working
 140   1        while(1){
 141   2          temperature();
 142   2          //Move();
 143   2          //Crying();
 144   2          //LCD_println("ABCDE");
 145   2        }
 146   1      }
 147          
 148          
 149          
 150          void Font_test(void) {
 151   1        int x=1234;
 152   1        LCD_fillScreen(BLACK);
 153   1        LCD_print2C(20,30,"abcd",1,WHITE,BLACK);
 154   1        LCD_print2C(80,30,"xyz",2,WHITE,BLACK);
 155   1        LCD_printC(20,60,"3.95' ILI9488 320X480",3,YELLOW);
 156   1        LCD_printC(20,120,"Test 2017-11-23",3,GREEN);
 157   1        LCD_println("");
 158   1        LCD_setTextSize(2);
 159   1        LCD_setText1Color(WHITE);
 160   1        LCD_println("ABCDabcd1234");
 161   1        LCD_println("~!@#$%^&*()_+{}:<>?/|-+.");
 162   1        LCD_setTextSize(2);
 163   1        LCD_setText1Color(YELLOW);
 164   1        LCD_printHebln("אבגדהוזחטיכלמנסעפצקרשת");
 165   1        LCD_println("ABCDE");
 166   1        printf("x=%d  \n",x);
 167   1        printf("abcdABCD1234",x);
 168   1        while(T_IRQ);
 169   1      }
 170          
 171          
 172          
 173          //printf("Enter the maximum time in seconds: ");  /??
 174          
 175          
 176          
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 4   

 177          sbit senMove=P1^0;                                   //   MOVE  CODE
 178          
 179          void Move(void) {
 180   1        int cnt=0, numSec=0;
 181   1        numSec=15000; // ?
 182   1        
 183   1      while(1)
 184   1      {
 185   2        cnt++;
 186   2        delay_ms(1000);
 187   2        if ((senMove=='0') && (cnt==15)){
 188   3        //if (cnt==15){
 189   3          break;
 190   3        }
 191   2        if((senMove=='1') && (cnt==15)){
 192   3          break;
 193   3        }
 194   2      }
 195   1      
 196   1        if (senMove=='1')
 197   1        {
 198   2          printf("detect the movement! \n");
 199   2          SetTarget(1);   
 200   2          printf("**0528606455");    // Yuval
 201   2          delay_ms(1000);
 202   2          printf("##detect the movement !");
 203   2          delay_ms(1000);
 204   2          printf("$$");
 205   2          delay_ms(1000);
 206   2          printf("&&");
 207   2          delay_ms(1000);
 208   2          printf("**0546224328");  // Enni
 209   2          delay_ms(1000);
 210   2          printf("##detect the movement !");
 211   2          delay_ms(1000);
 212   2          printf("$$");
 213   2          delay_ms(1000);
 214   2          printf("&&");
 215   2          delay_ms(1000);
 216   2          SetTarget(0);                       
 217   2          MenuScreen();
 218   2          cnt=0;
 219   2            }
 220   1        Crying();
 221   1          }
 222            //while(T_IRQ);
 223             
 224            
 225          
 226          
 227          
 228          
 229          
 230          
 231          // P2.0 num=0,P2.1 num=1,P2.2 num=2,P2.3 num=3,P2.5 num=4,P2.6 num=5,P3.0 num=6,P3.1 num=7,P3.4 num=8,P3.5
             - num=9,           
 232          // P3.7 num=10,P4.0 num=11,P4.3 num=12,P4.4 num=13,P4.5 num=14,P4.6 num=15
 233          // P0.3 num=17, P0.4 num=18,P1.1 num=19, P1.2 num=20, P1.0 num=21, P1.3 num=22, P1.6 num=23, P1.7 num=24,
 234          //  P2.4 num=25, P2.7 num=26, P3.2 num=27, P3.3 num=28, P3.6 num=29, P4.1 num=32, P4.2 num=33, P4.7 num=34
 235          // Temp Sensor num=30, VDD   num=31
 236          
 237          int ADC_IN(int num)
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 5   

 238          {
 239   1        AMX0N     = 0x1F;// negtive input= GND
 240   1        AMX0P=num;
 241   1        delay_us(1);
 242   1        AD0BUSY=1; // start conversion 
 243   1        while(!AD0INT); // wait end convesion 
 244   1        AD0INT = 0;   // clear ADC0 conversion complete flag 
 245   1        return (ADC0);
 246   1      }
 247          
 248          
 249              float CalcTemp(int digVal)
 250            {
 251   1          float temp, analog_val;
 252   1          //analog_val=((float)digVal*100);
 253   1          // 2->  analog_val=((float)digVal*3.3/1024)*0.01;
 254   1          analog_val=((float)digVal/1024)*3.3;
 255   1          // 2->  temp=analog_val;
 256   1          temp=analog_val/0.01;
 257   1          //temp=analog_val;
 258   1          return temp;
 259   1        }
 260          
 261          void temperature(void) {                              //  TEMPERATURE  CODE
 262   1        int val;
 263   1        while(1)
 264   1        {
 265   2          float temp;
 266   2          val=ADC_IN(READ_FROM_TEMP);
 267   2          temp=CalcTemp(val);
 268   2          LCD_fillScreen(RED);
 269   2          LCD_setCursor (10, 0);
 270   2          printf("the temperature in the room is:\n %f \n", temp);
 271   2          if (temp>29){
 272   3            printf("the temperature is too high !");
 273   3            SetTarget(1);   // before sending to BT switch printf to uart
 274   3           //printf("**0522547704");
 275   3            printf("**0546224328");     // Enni
 276   3            delay_ms(1000);
 277   3            printf("##the temperature is too high !");
 278   3            delay_ms(1000);
 279   3            printf("$$");
 280   3            delay_ms(1000);
 281   3            printf("&&");
 282   3            delay_ms(1000);
 283   3            printf("**0528606455");    // Yuval
 284   3            delay_ms(1000);
 285   3            printf("##the temperature is too high !");
 286   3            delay_ms(1000);
 287   3            printf("$$");
 288   3            delay_ms(1000);
 289   3            printf("&&");
 290   3            delay_ms(1000);
 291   3            SetTarget(0);
 292   3            MenuScreen();
 293   3          }
 294   2          if (temp<25){
 295   3            printf("the temperature is too low !");
 296   3            SetTarget(1); 
 297   3            printf("**0546224328");          // Enni
 298   3            delay_ms(1000);
 299   3            printf("##the temperature is too low !");
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 6   

 300   3            delay_ms(1000);
 301   3            printf("$$");
 302   3            delay_ms(1000);
 303   3            printf("&&");
 304   3            delay_ms(1000);    
 305   3            printf("**0528606455");      // Yuval
 306   3            delay_ms(1000);
 307   3            printf("##the temperature is too low !");
 308   3            delay_ms(1000);
 309   3            printf("$$");
 310   3            delay_ms(1000);
 311   3            printf("&&");
 312   3            delay_ms(1000);        
 313   3            SetTarget(0);
 314   3            MenuScreen();
 315   3          }
 316   2          Move();
 317   2             //MenuScreen();         
 318   2          //while(T_IRQ);
 319   2         }
 320   1      }
 321          
 322          
 323          
 324          
 325          int IsAlarmDetected2()
 326          {
 327   1        int mag_temp,detect;
 328   1        int j,i;
 329   1        int k=0;
 330   1        num=0;
 331   1        LCD_fillScreen(BLACK);
 332   1        for(j=0;j<NUM_OF_FREQ_TO_CHECK;j++)
 333   1        {
 334   2          NumInstans[j] = 0;  
 335   2        }
 336   1        for(j=0;j<600/NUM_OF_FREQ_TO_CHECK;j++)
 337   1        {   
 338   2          for(i=0;i<205;i++)   
 339   2           { 
 340   3              data_in[i]=2*ADC_IN(20);  //P1.2 num=20
 341   3              delay_us(112);//dt sample
 342   3              
 343   3           }  
 344   2      
 345   2          for(i=0;i<NUM_OF_FREQ_TO_CHECK;i++)
 346   2           {
 347   3             mag_temp=(int)(goertzel_mag(205,wave_property_arr[i].freq,8000));
 348   3             k++; 
 349   3            //sprintf(my_string,"m=%3d f=%3d i=%d",mag_temp,wave_property_arr[i].freq,NumInstans[i]);
 350   3      if ((k%20==0) || (k%20==1))
 351   3      {
 352   4             
 353   4            LCD_setCursor (10, 100);
 354   4            if (i==0) 
 355   4            {  
 356   5              LCD_setCursor (10, 0);
 357   5              printf("m=%3d f=%3d i=%d",mag_temp,wave_property_arr[i].freq,NumInstans[i]);
 358   5            }
 359   4      
 360   4            if (i==1) 
 361   4            {  
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 7   

 362   5              LCD_setCursor (10,100);
 363   5              printf("m=%3d f=%3d i=%d",mag_temp,wave_property_arr[i].freq,NumInstans[i]);
 364   5            }
 365   4      
 366   4            if (i==2) 
 367   4            {  
 368   5              LCD_setCursor (10, 200);
 369   5              printf("m=%3d f=%3d i=%d",mag_temp,wave_property_arr[i].freq,NumInstans[i]);
 370   5            }
 371   4            
 372   4            if (i==3) 
 373   4            {  
 374   5              LCD_setCursor (10, 200);
 375   5              printf("m=%3d f=%3d i=%d",mag_temp,wave_property_arr[i].freq,NumInstans[i]);
 376   5            }
 377   4          
 378   4      }         
 379   3             
 380   3          //   if (i==1) LCD_print2C(20,100,my_string,2,RED, BLACK);
 381   3          //   if (i==2) LCD_print2C(20,200,my_string,2,RED, BLACK);
 382   3                 
 383   3      //       if (i==0) lcd_string_line(1,0,my_string);
 384   3      //       if (i==1) lcd_string_line(2,0,my_string);
 385   3      //       if (i==2) lcd_string_line(1,0,my_string);
 386   3      //       wait_ms(50);        
 387   3             if (mag_temp > wave_property_arr[i].Th_mag)
 388   3             {
 389   4               NumInstans[i]++;
 390   4             }
 391   3           }
 392   2           
 393   2         }
 394   1         
 395   1         detect=1;
 396   1         for(i=0;i<NUM_OF_FREQ_TO_CHECK;i++)
 397   1         {
 398   2           if (NumInstans[i] < wave_property_arr[i].Th_NumInstans)
 399   2           {
 400   3              detect = 0 ;
 401   3              break;
 402   3           }       
 403   2         }
 404   1         return(detect);
 405   1      }
 406          
 407          
 408          
 409          
 410          
 411          float goertzel_mag(int numSamples,int TARGET_FREQUENCY,int SAMPLING_RATE)
 412          {
 413   1      
 414   1        int     k,i;
 415   1        float analog;
 416   1        float   floatnumSamples;
 417   1        float   omega,sine,cosine,coeff,q0,q1,q2,magnitude,real,imag;
 418   1        float   scalingFactor = numSamples / 2.0;
 419   1      
 420   1        floatnumSamples = (float) numSamples;
 421   1        k = (int) (0.5 + ((floatnumSamples * TARGET_FREQUENCY) / SAMPLING_RATE));
 422   1        omega = (2.0 * 3.14 * k) / floatnumSamples;
 423   1        sine = sin(omega);
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 8   

 424   1        cosine = cos(omega);
 425   1        coeff = 2.0 * cosine;
 426   1        q0=0;
 427   1        q1=0;
 428   1        q2=0;
 429   1      
 430   1        for(i=0; i<numSamples; i++)
 431   1        {
 432   2          analog=data_in[i];
 433   2          q0 = coeff * q1 - q2 + analog;
 434   2          q2 = q1;
 435   2          q1 = q0;
 436   2        }
 437   1      
 438   1        // calculate the real and imaginary results
 439   1        // scaling appropriately
 440   1        real = (q1 - q2 * cosine) / scalingFactor;
 441   1        imag = (q2 * sine) / scalingFactor;
 442   1      
 443   1        magnitude = sqrt(real*real + imag*imag);
 444   1      
 445   1        return magnitude;
 446   1      }
 447          
 448          
 449          
 450          
 451          void Crying(void) {                                                   //   Crying  CODE
 452   1          int status;
 453   1         int cnt=0, numSec=15000;   
 454   1        LCD_fillScreen(RED);
 455   1        delay_ms(100);
 456   1        //LCD_print2C(0 ,50 ,"voice",3, WHITE, BLACK);
 457   1        
 458   1      
 459   1        while(1)
 460   1        {
 461   2          status = IsAlarmDetected2();
 462   2          cnt++;
 463   2          delay_ms(1000);
 464   2          if ((status==0) && (cnt==15))
 465   2          //if (cnt==15)
 466   2            break;
 467   2          if (status==1)
 468   2            break;
 469   2        }
 470   1      
 471   1          if (status==1)
 472   1          {     
 473   2            printf("\nThe baby is crying !\n");  //print the message
 474   2          
 475   2            SetTarget(1); 
 476   2            printf("**0546224328");  //send SMS to Enni
 477   2            delay_ms(1000);
 478   2            printf("##The baby is crying !");
 479   2            delay_ms(1000);
 480   2            printf("$$");
 481   2            delay_ms(1000);
 482   2            printf("&&");
 483   2            delay_ms(1000);
 484   2            printf("**0528606455");  //send SMS to Yuval
 485   2            delay_ms(1000);
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 9   

 486   2            printf("##The baby is crying !");
 487   2            delay_ms(1000);
 488   2            printf("$$");
 489   2            delay_ms(1000);
 490   2            printf("&&");
 491   2            delay_ms(1000);
 492   2            SetTarget(0);
 493   2            MenuScreen();
 494   2            play_song(1,1);    //start playing the lullaby
 495   2            LCD_setCursor (10,140);
 496   2            delay_ms(360000); // 6 minutes
 497   2            play_song(1,2); 
 498   2            LCD_setCursor (10,140);
 499   2            delay_ms(360000);
 500   2            play_song(1,3); 
 501   2            LCD_setCursor (10,140);
 502   2            delay_ms(360000);
 503   2            play_song(1,4); 
 504   2            LCD_setCursor (10,140);
 505   2            delay_ms(360000);
 506   2            play_song(1,5);
 507   2            LCD_setCursor (10,140);
 508   2            delay_ms(360000);
 509   2          }
 510   1          cnt=0;  
 511   1      }
 512          
 513          
 514          
 515          
 516          
 517          //int j=1;
 518          void mp3()                          //   MP3   CODE  
 519          {
 520   1        LCD_fillScreen(BLACK);
 521   1        LCD_setCursor (10,100);
 522   1        printf("press touch to play\n");
 523   1        while(T_IRQ);
 524   1        
 525   1        play_song(1,1); 
 526   1        LCD_setCursor (10,140);
 527   1        delay_ms(360000);  // 6 minutes
 528   1        printf("press to start playing the lullaby \n");
 529   1        play_song(1,2); 
 530   1        LCD_setCursor (10,140);
 531   1        delay_ms(360000);
 532   1        printf("press to start playing the lullaby \n");
 533   1        play_song(1,3); 
 534   1        LCD_setCursor (10,140);
 535   1        delay_ms(360000);
 536   1        printf("press to start playing the lullaby \n");
 537   1        play_song(1,4); 
 538   1        LCD_setCursor (10,140);
 539   1        delay_ms(360000);
 540   1        printf("press to start playing the lullaby \n");
 541   1        play_song(1,5);
 542   1        LCD_setCursor (10,140);
 543   1        delay_ms(360000);
 544   1        printf("press to start playing the lullaby \n");
 545   1        
 546   1        while(T_IRQ);
 547   1        MenuScreen();
C51 COMPILER V9.59.0.0   MAIN                                                              04/27/2023 08:19:20 PAGE 10  

 548   1      }
 549          
 550          
 551           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4044    ----
   CONSTANT SIZE    =   2126    ----
   XDATA SIZE       =    484      80
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
